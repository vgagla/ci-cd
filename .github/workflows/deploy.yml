name: Deploy to Environment

on:
  push:
    branches:
      - dev
      - staging
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Map branches to GitHub Environments
    environment: ${{ github.ref_name == 'main' && 'production' || github.ref_name == 'dev' && 'development' || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display deployment info
        run: |
          echo "ðŸš€ Deploying to: ${{ vars.SITE_TITLE }}"
          echo "ðŸ“‚ Deploy path: ${{ vars.DEPLOY_PATH }}"
          echo "ðŸŽ¨ Site color: ${{ vars.SITE_COLOR }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ðŸ”‘ SSH Key loaded: ${{ secrets.SSH_PRIVATE_KEY != '' }}"

      - name: Replace placeholders with environment values
        run: |
          DEPLOY_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          # Replace placeholders in all files
          sed -i "s|__SITE_TITLE__|${{ vars.SITE_TITLE }}|g" index.html
          sed -i "s|__SITE_COLOR__|${{ vars.SITE_COLOR }}|g" style.css
          sed -i "s|__DEPLOY_TIME__|${DEPLOY_TIME}|g" index.html
          sed -i "s|__COMMIT_SHA__|${COMMIT_SHA}|g" index.html
          sed -i "s|__SITE_TITLE__|${{ vars.SITE_TITLE }}|g" app.js
          sed -i "s|__DEPLOY_TIME__|${DEPLOY_TIME}|g" app.js

          echo "âœ… Placeholders replaced"
          echo "--- index.html preview ---"
          head -5 index.html

      - name: Deploy to EC2 via SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
          DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}
          DEPLOY_USER: ${{ vars.DEPLOY_USER }}
        run: |
          # Set up SSH key
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null

          # Deploy files via SCP
          scp -i ~/.ssh/deploy_key -r index.html style.css app.js \
            $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/

          echo "âœ… Deployed to $DEPLOY_HOST:$DEPLOY_PATH"

      - name: Verify deployment
        env:
          DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
          DEPLOY_USER: ${{ vars.DEPLOY_USER }}
          DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST "ls -la $DEPLOY_PATH"
          echo "âœ… Deployment verified!"